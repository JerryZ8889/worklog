以下是这个项目的另一个核心【数据字段】（已按实际代码更新数据源）

> ⚠️ 重要变更：价格/均线/热度数据源已从 510500 ETF 改为中证500**指数**（000905.SH）。指数数据天然为全收益口径，无需复权处理，简化了数据管道。仅 ETF 换手率仍取自 510500 ETF。

**一、 核心行情数据 (OHLCV)**

源数据： 000905.SH 中证500指数（通过 Tushare `index_daily` 接口获取）

1. trade_date (交易日期)

- 作用 ：作为所有数据对齐的时间轴主键。

2. close (收盘点位)

- 核心作用 ：

- 计算均线系统（MA5, MA10, MA20, MA30）。

- 判断趋势方向（连涨天数 `consec_gains`）。

- 计算策略收益率。

- 触发"首阴"信号（今日收盘 < 昨日收盘）。

- 判断趋势保护（与 MA30/MA10/MA5 的关系）。

3. high (最高点位)

- 核心作用 ：

- 止损逻辑 ：用于记录买入当日的"入场最高价 (`entry_high`)"。如果 FirstNeg 模式持仓 5 天内收盘价未能突破该最高价，叠加跌破 MA30 时触发卖出。

4. open (开盘点位)

- 核心作用 ：

- T+1 执行：买入/卖出均以**次日开盘价**执行，用于计算执行日的实际收益。

5. amount (成交额)

- 核心作用 ：

- 资金热度 ：用于计算 `heat_z`（指数成交额 Z-Score），判断市场是否过热（>1.5σ）。

- 注意：使用的是**中证500指数的成交额**，不是 ETF 的成交额，也不是成交量。

6. volume (成交量)

- 作用 ：辅助字段，策略核心逻辑不直接使用，但保留在数据表中供参考。

7. low (最低点位)

- 作用 ：辅助字段，策略核心逻辑不直接使用，K线绘图时需要。

**二、 均线系统 (Moving Averages)**

基于中证500指数 close 滚动计算：

8. ma_5 (5日均线 / MA_Support)

- 作用 ：FirstNeg 入场条件之一，确认价格有短期支撑（close > ma_5）。

9. ma_10 (10日均线 / MA_Trend)

- 作用 ：FirstNeg 入场条件之一，确认短期趋势向上（close > ma_10）。

10. ma_20 (20日均线)

- 作用 ：中期趋势参考。策略核心逻辑不直接使用，但保留在数据表中。

11. ma_30 (30日均线 / MA_Filter)

- 作用 ：中期趋势的多空分界线。FirstNeg 入场条件之一（close > ma_30）。FirstNeg 退出的前提条件（close < ma_30）。

**三、 市场情绪数据 (Sentiment)**

12. breadth (市场广度)

- 定义 ：中证500成分股中，股价站上 20日均线 的股票占比（%）。

- 数据来源 ：基于本地 `stocks_data/` 文件夹中的个股数据 + `csi500_components_schedule.csv` 成分股时间表，在 `build_strategy_data.py` 中计算。

- 核心作用 ：

- 抄底信号 ：当 breadth < 16 时触发 Composite 模式买入。

- 逃顶信号 ：当 breadth > 79 时（叠加 heat_z < 1.5）触发通用卖出。

- 状态升级 ：FirstNeg 持仓中若 breadth < 16，升级为 Composite。

**四、 资金热度 (Heat)**

13. heat_z (成交额 Z-Score)

- 定义 ：中证500指数成交额的 rolling(20) Z-Score。

- 公式 ：`(当日指数amount - 过去20日amount均值) / 过去20日amount标准差`

- 核心作用 ：

- 通用卖出条件的组成部分：breadth > 79 且 heat_z < 1.5 时卖出（缩量普涨 = 见顶）。

**五、 流动性数据 (Liquidity)**

14. etf_turnover (ETF换手率)

- 定义 ：510500 ETF 的换手率。

- 公式 ：`etf_vol(手) / fd_share_T-1(万份)`

- 数据来源 ：Tushare `fund_daily`（获取 vol）+ `fund_share`（获取 fd_share），分母使用 T-1 的份额（因为份额变动是盘后公布）。

- 核心作用 ：

- 活跃度确认 ：在 FirstNeg 模式下，要求 etf_turnover > 1.0 才能开仓，确保市场有足够的活跃资金承接。

**总结：数据检查清单**

| 字段名 | 中文名 | 来源 | 必须性 | 缺失后果 |
| --- | --- | --- | --- | --- |
| trade_date | 日期 | 指数日线 | ⭐⭐⭐ | 无法对齐数据 |
| close | 收盘点位 | 000905.SH 指数 | ⭐⭐⭐ | 无法计算信号和收益 |
| high | 最高点位 | 000905.SH 指数 | ⭐⭐⭐ | 无法执行"5日不创新高"止损 |
| open | 开盘点位 | 000905.SH 指数 | ⭐⭐⭐ | 无法计算 T+1 执行收益 |
| amount | 成交额 | 000905.SH 指数 | ⭐⭐⭐ | 无法计算热度 heat_z |
| breadth | 广度 | 本地个股数据计算 | ⭐⭐⭐ | 无法判断冰点/高潮，策略失效 |
| etf_turnover | ETF换手率 | 510500 ETF | ⭐⭐ | 无法确认首阴买点 |
| ma_5 | 5日均线 | 指数 close 计算 | ⭐⭐ | FirstNeg 支撑判断缺失 |
| ma_10 | 10日均线 | 指数 close 计算 | ⭐⭐ | FirstNeg 趋势判断缺失 |
| ma_30 | 30日均线 | 指数 close 计算 | ⭐⭐⭐ | 趋势过滤和 FirstNeg 退出判断缺失 |
| volume | 成交量 | 000905.SH 指数 | ⭐ | 辅助字段，不影响策略 |
| low | 最低点位 | 000905.SH 指数 | ⭐ | 辅助字段，K线绘图用 |
| ma_20 | 20日均线 | 指数 close 计算 | ⭐ | 辅助字段，不影响策略 |

**针对 Tushare Pro 的数据获取整理：**

1. 指数日线行情（中证500指数）

   a. 用途 ：价格、均线、成交热度——策略的核心数据源。

   b. Tushare 接口 ： `index_daily`

   c. 目标代码 ： `000905.SH`（中证500指数）

   d. 获取字段 ：

| Tushare 字段名 | 含义 | 对应用途 |
| --- | --- | --- |
| trade_date | 交易日期 | 时间轴主键 |
| open | 开盘点位 | T+1 执行价 |
| high | 最高点位 | entry_high 止损 |
| low | 最低点位 | K线绘图 |
| close | 收盘点位 | 均线、趋势、收益计算 |
| vol | 成交量 | 重命名为 volume |
| amount | 成交额 | heat_z 计算 |

   e. 优势 ：指数数据天然为全收益口径，**无需复权处理**，避免了 ETF 后复权的复杂逻辑。

2. 市场广度数据（需自行计算）

   a. 用途 ：计算 breadth（股价 > MA20 的成分股占比）。

   b. 成分股列表 ：来自本地 `csi500_components_schedule.csv`

   c. 个股数据 ：来自本地 `stocks_data/` 文件夹（1074只股票，后复权处理）

   d. 计算逻辑 ：
   - 对每个交易日，根据 asof_date 确定当期成分股名单
   - 对每只成分股计算 MA20
   - 统计 close > MA20 的股票数量 / 当日有效股票总数 × 100%

3. ETF 换手率（仅此字段取自 ETF）

   a. 用途 ：计算 etf_turnover，确认首阴买点的资金活跃度。

   b. Tushare 接口 ：`fund_daily`（获取 vol）+ `fund_share`（获取 fd_share）

   c. 目标代码 ： `510500.SH`

   d. 计算公式 ：`etf_turnover = etf_vol / fd_share_T-1`

   e. 注意 ：分母使用 T-1 的 fd_share（前向填充后 shift(1)），因为份额变动盘后公布。

**总结：build_strategy_data.py 做这三件事**

1. `pro.index_daily(ts_code='000905.SH')` → 获取指数 OHLCV + amount → 计算 MA 和 heat_z
2. 本地 `stocks_data/` + `csi500_components_schedule.csv` → 计算 breadth
3. `pro.fund_daily(ts_code='510500.SH')` + `pro.fund_share` → 计算 etf_turnover
4. 合并为 `strategy_data.csv`（14列宽表）
