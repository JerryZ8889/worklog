一、 指标定义

1. 市场广度 (Breadth) ：

- 定义： df['breadth']
，即中证500成分股中站上20日均线的个股比例（%）；

- 冰点线 ：< 16%（极度恐慌）；

- 过热线 ：> 79%（极度贪婪）；

2. 资金热度 (Heat Z-Score) ：

- 定义： df['Heat_Z'] ，成交金额的 Z-Score
标准化值（默认窗口20天）。

- 公式： ( 当前成交额 -- 近20日均值 ) / 标准差 。

- 过热阈值 ：> 1.5σ。

> 附加解释：标准差指跟过往的波动率相比：

- 比如均值是100，平时也是100上下，今天是98，那无论跟绝对值比，还是标准差比都没什么变化；

- 但如果均值是100，平时有时50，有时150，今天是148，跟绝对值比就是可能加入考虑范围的异常值（差值有50%），但如果跟标准差比，平时波动也这么大，那结果就和上一个例子一样，没什么变化。

3. 趋势过滤器 (MA Filter) ：

- 定义： df['MA_Filter'] ，默认为 30日均线（MA30）。

- 作用：判断中期趋势的多空分界线。

4. 连涨动能 (Consecutive Gains) ：

- 定义： df['Consec_Gains'] ，连续上涨天数。

二、 策略买入逻辑 (Entry Logic)

策略每天检查是否触发买入，分为两种互斥的触发场景：

**场景 A：左侧极值抄底 (Composite Mode)**

- 触发条件 ：

1. 市场广度 < 16% ：全市场仅不到 16%
的股票在均线上方，判定为极度超卖的"冰点时刻"。

- 动作 ：

- 全仓买入。

- 将内部状态标记为 Composite （复合反转模式）。

**场景 B：右侧首阴低吸 (FirstNeg Mode)**

- 触发条件 （需同时满足以下所有条件）：

1. 趋势向上 ：收盘价 > 10日均线 ( MA_Trend )

2. 动能强劲 ：昨日至少已 连续上涨 3 天 ( Streak >= 3 )。

3. 首阴回调 ：今日收盘价 < 昨日收盘价（出现回调）。

4. 放量确认 ：ETF 换手率 ( Turnover_Pct ) > 1.0%（资金活跃）。

5. 支撑有效 ：收盘价 > 5日均线 ( MA_Support )。

6. 大趋势保护 ：当前收盘价 > 30日均线 ( MA_Filter )。

- 动作 ：

- 全仓买入。

- 将内部状态标记为 FirstNeg （首阴模式）。 状态流转特例 ：

如果当前处于 FirstNeg 持仓状态中，但市场突然崩盘导致广度跌破
16%，策略会自动将状态从 FirstNeg 升级为 Composite ，切换到左侧抄底逻辑。

三、 卖出逻辑 (Exit Logic)

卖出条件取决于当前所处的持仓模式（ Composite 或 FirstNeg ）：

1.  **通用卖出条件** (硬止盈 或
    硬止损)：无论哪种模式，只要满足以下条件立即清仓：

情绪过热 ：

- 市场广度 > 79% （全市场普涨，风险积聚）。

- 且 资金未过热 ( Heat_Z < 1.5 )。

附加解释：逻辑是 (temp['breadth'] > 79) & (temp['Heat_Z'] <
1.5) ，这里意味着如果是"缩量普涨"则卖出；如果成交量巨大（Heat_Z >
1.5）反而不卖，有资金推动的，可以先观察。

2.
**分模式止损/止盈**：如果不满足通用卖出条件，则根据模式分别判断：

如果是 Composite 模式 (抄底单) ：

- 宽容度极高 ：除了上述通用卖出条件外， 不设止损 。

- 逻辑
：相信冰点反转是中期底部，死扛直到广度过热（>79%）且成交量不足（Heat_Z
<1.5）才卖出。

如果是 FirstNeg 模式 (追涨单) ：严格风控 ，满足以下任一条件即卖出：

1. 跌破趋势线 ：收盘价 < 30日均线 ( MA_Filter )。

2. 短期止损 ：今日收盘价 < 昨日收盘价（连跌）。

3. 时间止损 (5日不创新高) ：持仓已超过 5 天，且这 5
天内收盘价未能突破买入时的最高价。

四、 交易执行细节

信号机制 ：

- signal = 1 ：买入信号（次日开盘买入）。

- signal = -1 ：卖出信号（次日开盘卖出）。

成本计算 ：

- 每次买卖产生 0.1% (千分之一) 的双边滑点/手续费成本 (
np.where(actual_p.diff() != 0, 0.001, 0) )。

总结：

这是一个"左侧抄底冰点，右侧追首阴"的混合策略：在市场极度恐慌时（广度<16%）无脑抄底并死扛至过热；在趋势良好时（MA30之上），利用连涨后的首次回调机会做短线波段，并设置了严格的趋势破位和时间止损保护。

补充：代码 细节

1.  **关于 Streak >= 3 的计算**：

在代码中，建议使用 (df['close'] >
df['close'].shift(1)).rolling(window=3).sum() == 3
来判定。确保是在"今日回踩"之前，已经有了连续 3 个上涨日。

2.  **关于 5日不创新高**：

在 FirstNeg 模式下，需要记录一个变量
entry_high（买入当日及之后达到的最高价）。如果 df['close'] 连续 5
天小于这个 entry_high，则触发卖出。

3.  **Heat_Z 的时效性**：

确保 Heat_Z 使用的是 **成交金额**
而不是成交量，因为金额更能反映真实资金的承接力。
