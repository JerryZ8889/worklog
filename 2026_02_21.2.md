Csi500_data文件夹里是2019年1月1日开始所有中证500成分股在其被收录在中证500时间里的数据，字段说明如下：
- ts_code ：股票代码；
- trade_date ：交易日期；
- close ：收盘价（用于计算 MA20，并与 MA20 比较）；
- pre_close ：昨收价（用于处理复权或极端缺失值）；
- vol ：成交量（可用于过滤停牌或极低流动性股票）；
- amount ：成交额（可用于过滤停牌或极低流动性股票）；

说明：
- MA20 是由 过去 20 个交易日的收盘价 计算出来的；
- 广度统计只关心"今日收盘价是否高于 MA20"，理论上只需要close收盘价就可以做出。
- 如果遇到停牌日，则用前一天的数据填充（向前填充ffill），这样保持M20的连续性，广度可比；
- 后复权需要用 adj_factor处理：
- 拉取 daily 日线数据（close/open/high/low）；
- 拉取 adj_factor （复权因子）；
- 合并后计算后复权价：adj_close = close * adj_factor / adj_factor_latest
  - 同理可以生成 adj_open 、 adj_high 、 adj_low；

拉取个股数据的promt（含有规则提示）：
- 时间从2018年11月1日至今；
- 每只股票对应一个文件；
- 我们对照csi500_components_schedule这个表格，注意每个时间段对应的中证500的成分股；
- 采用后复权；
- pre_close（前一天的收盘价）要用"前一天的复权结果" ，不能用"今天的复权因子"去复权"前一天的原始价格"；
- 如果遇到停牌采用前一天的数据填充；
- 每只股票我们获取ts_code, trade_date, close, pre_close, vol, amount这6个字段；
- 所有的个股数据都保存在刚建立的stocks_data中；
- 留意Trshare Pro 2000积分这一档的抓取频率限制；

一共1075只股票（按照2019年1月1日的前一个成分股发布日往后统计的），交易天数1729天。
实际获取1074只，600270.SH这只股票在2018年12月28日的成分股发布日当天退市，所以发布日当天有，但2019年1月1日就没有了，因此剔除。
规则：
- 如果 asof_date >= delist_date ，该股票 不能出现在 该 asof_date 的成分里；
- 如果 asof_date < delist_date ，即使这只股在当月成分表里，也可以保留；
  - asof_data（取样日期）；delist_data（退市日期）；

为了让总表能从19年1月1日开始，我们将这1074只成分股的数据时间往前推2个月，到2018年11月1日（因为2019年1月1日开始的ma_30数据需要往前30个交易日的数据）。

程序自己安排的操作逻辑：
- 读取股票清单：
  - 从 d:/Project/CSI500/stocks_data/ 读取所有 CSV 文件名，去掉后缀得到 1074 个 ts_code（之前已经根据csi500_components_schedule.csv获取了1074个名单，因此这里重做覆盖时只需要确认这1074个名单就行）。
  - 把这 1074 个代码写入临时文件： d:/Project/CSI500/tmp_stock_list.txt ，用于后续逐只读取。
- 构建完整交易日序列
  - 调用 Tushare trade_cal ，获取 2018-11-01 至今天的交易日历（SSE）。
  - 取其中 is_open=1 的日期作为完整交易日索引，用于停牌补齐。
- 逐只股票拉取全量原始数据 对每一只 ts_code 循环执行：
  - 通过 pro.daily 分页拉取 2018-11-01 至今天的日线数据（字段：ts_code, trade_date, close, pre_close, vol, amount）。
  - 通过 pro.adj_factor 分页拉取 2018-11-01 至今天的复权因子（字段：ts_code, trade_date, adj_factor）。
  - 使用 limit + offset 分页，避免单次返回截断；每次请求后 sleep 0.35s，满足 2000 积分频率限制。
- 合并与后复权计算
  - 按 ts_code + trade_date 将 daily 与 adj_factor merge。
  - 按日期升序排列，取最新一天的 adj_factor 作为基准（后复权到"最新复权尺度"）。
  - 计算后复权 close：close_adj = close_raw * adj_factor / latest_factor
- 停牌补齐与成交量处理
  - 将数据 reindex 到完整交易日索引（缺失交易日视为停牌）。
  - close 用前一交易日后复权 close 前向填充（ffill）。
  - vol/amount 缺失填 0（停牌无成交）。
- 正确生成 pre_close
  - 在"已经补齐并排序好的后复权 close"基础上，按日期升序计算：pre_close = close.shift(1) —— 这样保证"前收盘价=前一交易日后复权收盘价"，而不是用当天复权因子去复权前一日原价。
- 输出与覆盖
  - 最终字段保持： ts_code, trade_date, close, pre_close, vol, amount
  - 按日期降序排序后输出 CSV。
  - 为避免 Excel 锁文件导致写入失败，采用"先写临时文件，再原子替换"的方式覆盖原文件。
- 校验
  - 确认所有 1074 文件最早日期统一为 20181101。
  - 抽样检查 pre_close == 前一交易日 close 的一致性为 100%。
