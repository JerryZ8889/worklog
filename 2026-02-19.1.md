以下是这个项目最核心的【策略逻辑】（基于 策略Opus4.6.docx 代码逻辑版本，已确认采用）

<br>
一、 指标定义

1. 市场广度 (Breadth) ：

- 定义： `breadth` ，即中证500成分股中站上20日均线的个股比例（%）；

- 冰点线 ：< 16%（极度恐慌）；

- 过热线 ：> 79%（极度贪婪）；

2. 资金热度 (Heat Z-Score) ：

- 定义： `heat_z` ，**中证500指数（000905.SH）成交额**的 Z-Score 标准化值（默认窗口20天）。

- 公式： ( 当日指数成交额 − 近20日均值 ) / 标准差 。

- 过热阈值 ：> 1.5σ。

- 注意：使用的是**指数成交额 (amount)**，不是ETF成交额，也不是成交量 (volume)。

> 附加解释：标准差指跟过往的波动率相比：
> - 比如均值是100，平时也是100上下，今天是98，那无论跟绝对值比，还是标准差比都没什么变化；
> - 但如果均值是100，平时有时50，有时150，今天是148，跟绝对值比就是可能加入考虑范围的异常值（差值有50%），但如果跟标准差比，平时波动也这么大，那结果就和上一个例子一样，没什么变化。

3. 趋势过滤器 (MA Filter) ：

- 定义： `ma_30` ，默认为 30日均线（MA30），基于**中证500指数收盘价**计算。

- 作用：判断中期趋势的多空分界线。

4. 趋势线 (MA Trend)：

- 定义：`ma_10`，10日均线，基于**中证500指数收盘价**计算。

- 作用：判断短期趋势方向，FirstNeg 入场条件之一。

5. 支撑线 (MA Support)：

- 定义：`ma_5`，5日均线，基于**中证500指数收盘价**计算。

- 作用：FirstNeg 入场时确认价格仍有短期支撑。

6. 连涨动能 (Consecutive Gains) ：

- 定义： `consec_gains` ，连续上涨天数。

- 计算方式：使用**涨跌切换分组法**——每次涨跌方向切换时组号+1，组内累计天数即为连涨/连跌天数。上涨日取组内累计天数，非上涨日为0。

- 代码实现：
```python
df['is_up'] = (df['close'] > df['close'].shift(1)).astype(int)
df['streak_group'] = (df['is_up'] != df['is_up'].shift(1)).cumsum()
df['streak'] = df.groupby('streak_group').cumcount() + 1
df['consec_gains'] = np.where(df['is_up'] == 1, df['streak'], 0)
```

<br>
二、 策略买入逻辑 (Entry Logic)

策略每天收盘时检查是否触发买入信号，分为两种互斥的触发场景（按优先级排列）：

**场景 A：左侧极值抄底 (Composite Mode)** —— 优先判断

- 触发条件 ：

1. 市场广度 < 16% ：全市场仅不到 16% 的股票在均线上方，判定为极度超卖的"冰点时刻"。

- 动作 ：

- 产生买入信号（signal = 1），**次日开盘价执行买入**。

- 将内部状态标记为 `Composite` （复合反转模式）。

- 记录 `entry_idx`（入场日索引）和 `entry_high`（**仅记录入场当日的最高价，之后不更新**）。

**场景 B：右侧首阴低吸 (FirstNeg Mode)** —— 场景A不满足时才检查

- 触发条件 （需**同时满足**以下6项条件）：

1. 趋势向上 ：收盘价 > MA10 (`ma_10`)
2. 动能强劲 ：**昨日**连涨天数 >= 3 (`consec_gains[i-1] >= 3`)
3. 首阴回调 ：今日收盘价 < 昨日收盘价（出现回调）
4. 放量确认 ：ETF 换手率 (`etf_turnover`) > 1.0%（资金活跃）
5. 支撑有效 ：收盘价 > MA5 (`ma_5`)
6. 大趋势保护 ：收盘价 > MA30 (`ma_30`)

- 动作 ：

- 产生买入信号（signal = 1），**次日开盘价执行买入**。

- 将内部状态标记为 `FirstNeg` （首阴模式）。

- 记录 `entry_idx` 和 `entry_high`（**仅入场当日 high**）。

**状态升级特例** ：

如果当前处于 FirstNeg 持仓状态中，但市场突然崩盘导致广度跌破 16%，策略会自动将状态从 `FirstNeg` 升级为 `Composite`，切换到左侧抄底逻辑（不再受 FirstNeg 的严格止损约束）。

<br>
三、 卖出逻辑 (Exit Logic)

卖出条件取决于当前所处的持仓模式（ `Composite` 或 `FirstNeg` ）：

**1. 通用卖出条件（两种模式共用）：**

无论哪种模式，只要满足以下条件立即产生卖出信号：

- 市场广度 > 79% **且** 资金热度 Heat_Z < 1.5

- 逻辑：`(breadth > 79) and (heat_z < 1.5)`

- 解释：如果是"缩量普涨"则卖出；如果成交量巨大（Heat_Z > 1.5）反而不卖，有资金推动的行情可以先观察。

**2. 分模式退出：**

如果通用条件不满足，则根据模式分别判断：

**Composite 模式（抄底单）** ：

- 宽容度极高 ：除了上述通用卖出条件外，**不设额外止损**。

- 逻辑：相信冰点反转是中期底部，死扛直到广度过热（>79%）且成交量不足（Heat_Z < 1.5）才卖出。

**FirstNeg 模式（追涨单）** ：采用**条件组合退出**（非纯OR）：

- **前提条件** ：收盘价 < MA30 (`is_below_ma = curr_c < ma_f`)

- **叠加条件（满足任一即可）** ：
  - 条件a：今日收盘价 < 昨日收盘价（当日下跌，`is_1d`）
  - 条件b：持仓天数 >= 5 天，且期间所有收盘价均未超过 `entry_high`（5日不创新高，`is_5d`）

- 退出判定：`is_below_ma AND (is_1d OR is_5d)`

- 解释：**必须先跌破MA30趋势防线**，然后叠加"当日继续下跌"或"5天滞涨"的确认，才触发卖出。单独跌破MA30不卖，单独下跌也不卖。

> ⚠️ 重要说明：这里采用的是**代码逻辑版本**（策略Opus4.6.docx），与原始"策略逻辑.docx"不同。原文档为三个条件纯 OR（任一满足即卖出），实际代码是以跌破 MA30 为前提的组合条件。

<br>
四、 关于 entry_high 的说明

- **采用的逻辑**：仅记录入场当日的 `high` 值，之后不更新。

- 代码：`entry_high = df['high'].iloc[i]`（在买入信号产生时记录一次）。

- 用于5日不创新高的判断：检查入场后所有收盘价是否有超过这个固定的 entry_high。

> ⚠️ 与原文档差异：原始"策略逻辑.docx"暗示应滚动更新为"买入当日及之后达到的最高价"，但实际代码仅取入场当日 high。我们采用代码版本。

<br>
五、 交易执行细节

信号机制 ：

- signal = 1 ：买入信号（当日收盘时产生，**次日开盘价执行**）。

- signal = -1 ：卖出信号（当日收盘时产生，**次日开盘价执行**）。

- 这是 **T+1 执行模型**：信号在 T 日收盘后确认，T+1 日开盘价执行。

成本计算 ：

- 每次买入或卖出产生 **0.1%（千分之一）单边成本**，包含滑点和手续费。

- 买入执行日收益：`(close / open - 1) - 0.001`

- 卖出执行日收益：`(open / prev_close - 1) - 0.001`

- 正常持仓日收益：`close / prev_close - 1`

<br>
六、 总结

这是一个"左侧抄底冰点，右侧追首阴"的混合策略：在市场极度恐慌时（广度<16%）无脑抄底并死扛至过热；在趋势良好时（MA30之上），利用连涨后的首次回调机会做短线波段。FirstNeg 模式设置了以跌破MA30为前提的组合止损保护，避免单一条件的误判。Composite 模式则只在广度过热且资金降温时才退出，体现对冰点反转的强信念。

<br>
七、 数据源说明

- **价格数据（OHLCV）和均线系统**：全部基于中证500**指数**（000905.SH），无需复权。
- **资金热度（heat_z）**：基于中证500**指数**的成交额计算。
- **市场广度（breadth）**：基于中证500成分股个股数据，计算收盘价 > MA20 的占比。
- **ETF换手率（etf_turnover）**：仅此字段取自 510500 ETF（vol / fd_share_T-1）。
