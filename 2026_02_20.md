计划建立的数据表结构（已按实际代码更新数据源）

> ⚠️ 重要变更：OHLCV、均线、heat_z 数据源已从 510500 ETF 改为中证500**指数**（000905.SH）。指数数据无需复权，简化了整个数据管道。仅 etf_turnover 仍取自 510500 ETF。

所有核心数据整合为一张"宽表" (Wide Table) ，命名为 `strategy_data.csv`。

这张表以日期 (`trade_date`) 为主键，每一行包含该日期的所有决策所需数据。

| 字段名 (Column Name) | 数据类型 | 来源/计算逻辑 | 对应策略用途 |
| --- | --- | --- | --- |
| trade_date | String | Tushare 交易日历 | 时间对齐（主键） |
| open | Float | 000905.SH 中证500指数 (`index_daily`) | T+1 执行价格 |
| high | Float | 000905.SH 中证500指数 (`index_daily`) | 止损判断 (entry_high) |
| low | Float | 000905.SH 中证500指数 (`index_daily`) | K线绘图 |
| close | Float | 000905.SH 中证500指数 (`index_daily`) | 均线计算、收益计算、趋势判断 |
| volume | Float | 000905.SH 中证500指数 (`index_daily` vol 重命名) | 辅助字段 |
| amount | Float | 000905.SH 中证500指数 (`index_daily`) | heat_z 热度计算 |
| ma_5 | Float | `close.rolling(5).mean()` | 支撑线 (MA_Support) |
| ma_10 | Float | `close.rolling(10).mean()` | 趋势线 (MA_Trend) |
| ma_20 | Float | `close.rolling(20).mean()` | 中期趋势参考 |
| ma_30 | Float | `close.rolling(30).mean()` | 长期防守线 (MA_Filter) |
| breadth | Float (0-100) | 每日统计(成分股 close > MA20 占比) | 抄底/逃顶核心指标 |
| heat_z | Float | `(指数amount - rolling20均值) / rolling20标准差` | 资金热度 (通用卖出条件) |
| etf_turnover | Float | 510500 ETF `vol / fd_share_T-1` | 首阴低吸过滤器 (>1.0) |

补充说明：

- **数据源变更原因**：指数数据天然为全收益口径，无需复权处理。之前使用 ETF 数据需要后复权（fund_div 现金分红构造累积因子）、停牌填充等复杂处理，改用指数后这些都不需要了。
- 换手率分母：使用 T-1 份额（`fd_share.shift(1)`），因为份额变动盘后公布。
- breadth：基于成分股**后复权**收盘价计算 MA20（个股仍需后复权，但这是在 stocks_data 准备阶段已完成的）。
- 全表主键：trade_date，已按 trade_date 去重。
- 因为涉及到 ma_30 和 heat_z 的 rolling(20)，需要热身数据。如果需要 2019年1月1日 展示字段全满的数据，就需要往前推约 30 个交易日抓取数据，从 2018年11月01日 (`WARMUP_START`) 开始。

优点：

1. 易于回测 ：可以直接将这张表丢给回测引擎（backtest.py 的 Pandas 循环），一行行遍历即可，无需关心数据对齐问题。

2. 高性能 ：预先计算好 MA（均线）和 heat_z（热度）等指标并存储，运行时直接读取，避免每次运行策略都重复计算。

3. 清晰可读 ：打开 CSV 一眼就能看到每一天的所有状态：指数多少点？情绪多少分？资金热不热？非常直观。

4. 数据管道简洁 ：指数数据无需复权，减少了出错环节，提高了数据质量。

实施步骤（对应 `build_strategy_data.py` v5 的 4 个步骤）：

1. **STEP 1** — 拉取 000905.SH 指数日线：`pro.index_daily()`，获取 OHLCV + amount，无需复权。

2. **STEP 2** — 计算均线与热度：
   - MA5/MA10/MA20/MA30：`close.rolling(n).mean()`
   - heat_z：`(amount - amount.rolling(20).mean()) / amount.rolling(20).std()`

3. **STEP 3** — 计算 breadth：
   - 加载本地 `stocks_data/` 个股数据 + `csi500_components_schedule.csv` 成分股时间表
   - 对每只成分股计算 MA20，统计 close > MA20 的占比

4. **STEP 4** — 计算 etf_turnover：
   - `pro.fund_daily(510500.SH)` 获取 vol
   - `pro.fund_share(510500.SH)` 获取 fd_share
   - `etf_turnover = etf_vol / fd_share.shift(1)`

5. **汇总** — 截取目标区间（`TARGET_START` 起），输出 14 列 CSV。
